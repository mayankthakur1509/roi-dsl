name: Auto-compile ROI files and deploy subdomains

on:
  push:
    paths:
      - "**/*.roi"
      - "roi_compile.py"
      - "compiler/**"
      - ".github/workflows/**"

permissions:
  contents: write

jobs:
  compile-and-commit:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # -----------------------------
      # PYTHON
      # -----------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      # -----------------------------
      # DETECT CHANGED ROI FILES
      # -----------------------------
      - name: Detect changed ROI files
        id: changes
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            FILES=$(git diff --name-only $AFTER^ $AFTER | grep '\.roi$' || true)
          else
            FILES=$(git diff --name-only "$BEFORE" "$AFTER" | grep '\.roi$' || true)
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Show changed ROI files
        run: |
          echo "Changed files:"
          echo "${{ steps.changes.outputs.changed_files }}"

      # -----------------------------
      # COMPILE ALL OUTPUT TYPES
      # -----------------------------
      - name: Compile changed ROI files
        if: ${{ steps.changes.outputs.changed_files != '' }}
        run: |
          echo "${{ steps.changes.outputs.changed_files }}" | tr '\r' '\n' | while read -r f; do
            if [ -n "$f" ]; then
              echo "ðŸ”¥ Compiling: $f"

              python roi_compile.py compile "$f" --output mintsite --verbose || echo "MintSite failed for $f"
              python roi_compile.py compile "$f" --output cloudflare --verbose || echo "Cloudflare failed for $f"
              python roi_compile.py compile "$f" --output sdr --verbose || echo "SDR failed for $f"
            fi
          done

      - name: Fallback - compile all examples if none changed
        if: ${{ steps.changes.outputs.changed_files == '' }}
        run: |
          echo "No changed .roi files â€” compiling all examples."
          for f in examples/*.roi; do
            echo "ðŸ”¥ Compiling: $f"

            python roi_compile.py compile "$f" --output mintsite --verbose || echo "MintSite failed for $f"
            python roi_compile.py compile "$f" --output cloudflare --verbose || echo "Cloudflare failed for $f"
            python roi_compile.py compile "$f" --output sdr --verbose || echo "SDR failed for $f"
          done

      # -----------------------------
      # SHOW OUTPUTS
      # -----------------------------
      - name: Show outputs
        run: |
          echo "==== OUTPUTS GENERATED ===="
          ls -R outputs || echo "No outputs directory found"

      # -----------------------------
      # CHECK CLOUDFLARE OUTPUT
      # -----------------------------
      - name: Check Cloudflare output exists
        id: cf_check
        run: |
          if [ -d "outputs/cloudflare" ] && [ "$(ls -A outputs/cloudflare | wc -l)" -gt 0 ]; then
            echo "cloudflare_present=true" >> $GITHUB_OUTPUT
          else
            echo "cloudflare_present=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------
      # INSTALL WRANGLER
      # -----------------------------
      - name: Install Wrangler
        if: ${{ steps.cf_check.outputs.cloudflare_present == 'true' }}
        run: npm install -g wrangler

      # -----------------------------
      # DEPLOY SUBDOMAIN FOR EACH ROI FILE
      # -----------------------------
      - name: Deploy each client as subdomain
        if: ${{ steps.cf_check.outputs.cloudflare_present == 'true' }}
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          for dir in outputs/cloudflare/*; do
            if [ -d "$dir" ]; then
              CLIENT=$(basename "$dir")

              echo "ðŸš€ Deploying $CLIENT to subdomain:"
              echo "https://$CLIENT.${{ secrets.CF_PROJECT_NAME }}.pages.dev"

              wrangler pages deploy "$dir" \
                --project-name="${{ secrets.CF_PROJECT_NAME }}" \
                --branch="$CLIENT"
            fi
          done

      # -----------------------------
      # COMMIT & PUSH GENERATED OUTPUTS
      # -----------------------------
      - name: Commit and push outputs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add outputs || true

          if git diff --cached --quiet; then
            echo "No outputs changed."
            exit 0
          fi

          git commit -m "Auto-compiled ROI files (MintSite + Cloudflare + SDR) [ci skip]" || echo "Nothing to commit"
          git push origin "HEAD:${{ github.ref_name }}" || echo "Push failed"
