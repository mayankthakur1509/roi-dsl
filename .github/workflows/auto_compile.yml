name: Auto-compile ROI files and deploy to Cloudflare Pages

on:
  push:
    paths:
      - "**/*.roi"
      - "roi_compile.py"
      - "compiler/**"

permissions:
  contents: write

jobs:
  compile-and-commit:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # -----------------------------
      # PYTHON
      # -----------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      # -----------------------------
      # DETECT CHANGED ROI FILES
      # -----------------------------
      - name: Detect changed ROI files
        id: changes
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            FILES=$(git diff --name-only $AFTER^ $AFTER | grep '\.roi$' || true)
          else
            FILES=$(git diff --name-only "$BEFORE" "$AFTER" | grep '\.roi$' || true)
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Show changed ROI files
        run: echo "${{ steps.changes.outputs.changed_files }}"

      # -----------------------------
      # COMPILE ALL OUTPUT TYPES
      # -----------------------------
      - name: Compile ROI files (MintSite + Cloudflare + SDR)
        if: ${{ steps.changes.outputs.changed_files != '' }}
        run: |
          echo "${{ steps.changes.outputs.changed_files }}" | while read f; do
            if [ -n "$f" ]; then
              echo "----------------------------------"
              echo "ðŸ”¥ Compiling: $f"
              echo "----------------------------------"

              python roi_compile.py compile "$f" --output mintsite --verbose || true
              python roi_compile.py compile "$f" --output cloudflare --verbose || true
              python roi_compile.py compile "$f" --output sdr --verbose || true
            fi
          done

      # -----------------------------
      # PREVENT INFINITE CI LOOP
      # (Skip rebuilds triggered by compiled files)
      # -----------------------------
      - name: Add .gitignore rule for Cloudflare artifacts
        run: |
          echo "outputs/cloudflare/dist" >> .gitignore || true

      # -----------------------------
      # SHOW OUTPUTS
      # -----------------------------
      - name: Show outputs
        run: |
          echo "==== OUTPUTS GENERATED ===="
          ls -R outputs || echo "No outputs directory found"

      # -----------------------------
      # COMMIT & PUSH
      # -----------------------------
      - name: Commit and push outputs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add outputs || true

          if git diff --cached --quiet; then
            echo "No outputs changed."
            exit 0
          fi

          git commit -m "Auto-compiled ROI files (MintSite + Cloudflare + SDR) [ci skip]"
          git push origin HEAD:${{ github.ref_name }}
