name: Auto Compile + Deploy to Cloudflare

on:
  push:
    paths:
      - "**/*.roi"
      - "roi_compile.py"
      - "compiler/**"
      - ".github/workflows/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install pip + dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Detect changed ROI files
        id: changes
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            FILES=$(git diff --name-only $AFTER^ $AFTER | grep '\.roi$' || true)
          else
            FILES=$(git diff --name-only "$BEFORE" "$AFTER" | grep '\.roi$' || true)
          fi
          echo "FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compile ROI files
        run: |
          FILES="${{ steps.changes.outputs.FILES }}"
          if [ -z "$FILES" ]; then
            echo "No ROI changed. Compiling everything."
            FILES=$(ls examples/*.roi)
          fi

          echo "$FILES" | while read f; do
            echo "ðŸ”¥ Compiling $f"
            python roi_compile.py compile "$f" --output cloudflare --verbose || echo "Compile failed"
          done

      - name: Show Cloudflare output
        run: |
          echo "====== OUTPUTS/CLOUDFLARE ======"
          ls -R outputs/cloudflare

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ secrets.CF_PROJECT_NAME }}
          directory: outputs/cloudflare
